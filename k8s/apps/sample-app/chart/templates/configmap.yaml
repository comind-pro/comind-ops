apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sample-app.fullname" . }}-config
  labels:
    {{- include "sample-app.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
data:
  {{- range $key, $value := .Values.configMap }}
  {{ $key }}: |
{{ $value | indent 4 }}
  {{- end }}
  
  # Platform service configuration
  platform-services.yaml: |
    database:
      {{- toYaml .Values.platformServices.database | nindent 6 }}
    queue:
      {{- toYaml .Values.platformServices.queue | nindent 6 }}
    storage:
      {{- toYaml .Values.platformServices.storage | nindent 6 }}
    cache:
      {{- toYaml .Values.platformServices.cache | nindent 6 }}
  
  # Application metadata
  app-metadata.json: |
    {
      "name": "{{ include "sample-app.fullname" . }}",
      "version": "{{ .Chart.AppVersion }}",
      "environment": "{{ .Values.global.environment }}",
      "namespace": "{{ .Values.global.namespace }}",
      "domain": "{{ .Values.global.domain }}",
      "build": {
        "timestamp": "{{ now | date "2006-01-02T15:04:05Z" }}",
        "chart_version": "{{ .Chart.Version }}"
      },
      "platform": {
        "kubernetes": true,
        "comind-ops": true,
        "argocd": true
      },
      "features": {
        "database": {{ .Values.platformServices.database.enabled }},
        "queue": {{ .Values.platformServices.queue.enabled }},
        "storage": {{ .Values.platformServices.storage.enabled }},
        "cache": {{ .Values.platformServices.cache.enabled }},
        "monitoring": {{ .Values.monitoring.serviceMonitor.enabled }},
        "autoscaling": {{ .Values.autoscaling.enabled }},
        "networkPolicy": {{ .Values.networkPolicy.enabled }}
      }
    }
    
  # Health check endpoints
  health-endpoints.txt: |
    # Health check endpoints for monitoring
    /health     - Liveness probe endpoint
    /ready      - Readiness probe endpoint  
    /startup    - Startup probe endpoint
    /metrics    - Prometheus metrics endpoint
    /info       - Application information
    
  # Queue configuration
  {{- if .Values.platformServices.queue.enabled }}
  queue-config.json: |
    {
      "host": "{{ .Values.platformServices.queue.host }}",
      "port": {{ .Values.platformServices.queue.port }},
      "region": "{{ .Values.platformServices.queue.region }}",
      "queues": {{ .Values.platformServices.queue.queues | toJson }},
      "endpoints": {
        {{- range .Values.platformServices.queue.queues }}
        "{{ . }}": "http://{{ $.Values.platformServices.queue.host }}:{{ $.Values.platformServices.queue.port }}/queue/{{ . }}"{{- if ne . (last $.Values.platformServices.queue.queues) }},{{- end }}
        {{- end }}
      }
    }
  {{- end }}
  
  # Storage bucket configuration  
  {{- if .Values.platformServices.storage.enabled }}
  storage-config.json: |
    {
      "endpoint": "{{ .Values.platformServices.storage.endpoint }}",
      "secure": {{ .Values.platformServices.storage.secure }},
      "buckets": {{ .Values.platformServices.storage.buckets | toJson }},
      "urls": {
        {{- range .Values.platformServices.storage.buckets }}
        "{{ . }}": "{{ if $.Values.platformServices.storage.secure }}https://{{ else }}http://{{ end }}{{ $.Values.platformServices.storage.endpoint }}/{{ . }}"{{- if ne . (last $.Values.platformServices.storage.buckets) }},{{- end }}
        {{- end }}
      }
    }
  {{- end }}
