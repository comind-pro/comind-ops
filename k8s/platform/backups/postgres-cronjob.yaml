---
# Postgres Backup CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: backup-system
  labels:
    app: postgres-backup
    component: backup
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: postgres-backup
            component: backup
        spec:
          serviceAccountName: backup-operator
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 999  # postgres user
            fsGroup: 999
          containers:
          - name: postgres-backup
            image: postgres:15-alpine
            imagePullPolicy: IfNotPresent
            command: ["/bin/sh"]
            args:
            - -c
            - |
              set -e

              # Backup configuration
              BACKUP_NAME="postgres-backup-$(date +%Y%m%d-%H%M%S)"
              BACKUP_PATH="/backups/${BACKUP_NAME}"
              RETENTION_DAYS=${RETENTION_DAYS:-7}

              echo "Starting PostgreSQL backup: $BACKUP_NAME"
              echo "Timestamp: $(date)"
              echo "Retention: $RETENTION_DAYS days"

              # Create backup directory
              mkdir -p "$BACKUP_PATH"

              # Perform database backup
              echo "Creating database dump..."
              pg_dumpall \
                -h "$POSTGRES_HOST" \
                -p "$POSTGRES_PORT" \
                -U "$POSTGRES_USER" \
                --clean \
                --if-exists \
                --no-password \
                > "$BACKUP_PATH/dump.sql"

              # Create backup metadata
              cat > "$BACKUP_PATH/metadata.json" << EOF
              {
                "timestamp": "$(date -Iseconds)",
                "hostname": "$POSTGRES_HOST",
                "port": "$POSTGRES_PORT",
                "user": "$POSTGRES_USER",
                "backup_type": "full",
                "compression": "gzip",
                "size_mb": "$(du -m "$BACKUP_PATH/dump.sql" | cut -f1)"
              }
              EOF

              # Compress backup
              echo "Compressing backup..."
              gzip "$BACKUP_PATH/dump.sql"

              # Update metadata with compressed size
              COMPRESSED_SIZE=$(du -m "$BACKUP_PATH/dump.sql.gz" | cut -f1)
              sed -i "s/\"size_mb\": \"[0-9]*\"/\"size_mb\": \"$COMPRESSED_SIZE\"/" "$BACKUP_PATH/metadata.json"

              echo "Backup completed: $BACKUP_PATH/dump.sql.gz ($COMPRESSED_SIZE MB)"

              # Upload to MinIO (if configured)
              if [ -n "$MINIO_ENDPOINT" ]; then
                echo "Uploading to MinIO..."
                mc alias set backup "$MINIO_ENDPOINT" "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY"
                mc cp -r "$BACKUP_PATH" "backup/$MINIO_BUCKET/postgres/"
                echo "Upload completed"
              fi

              # Clean up old backups (local)
              echo "Cleaning up backups older than $RETENTION_DAYS days..."
              find /backups -name "postgres-backup-*" -type d -mtime +$RETENTION_DAYS -exec rm -rf {} \; || true

              # Clean up old backups (MinIO)
              if [ -n "$MINIO_ENDPOINT" ]; then
                echo "Cleaning up old MinIO backups..."
                mc find "backup/$MINIO_BUCKET/postgres/" --name "postgres-backup-*" --older-than "${RETENTION_DAYS}d" --exec "mc rm -r {}"
              fi

              echo "PostgreSQL backup completed successfully at $(date)"
            env:
            - name: POSTGRES_HOST
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: host
            - name: POSTGRES_PORT
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: port
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: password
            - name: MINIO_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: minio-endpoint
                  optional: true
            - name: MINIO_BUCKET
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: minio-bucket
                  optional: true
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: minio-access-key
                  optional: true
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: minio-secret-key
                  optional: true
            - name: RETENTION_DAYS
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: retention-days
                  optional: true
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                - ALL
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "1Gi"
                cpu: "500m"
            volumeMounts:
            - name: backup-storage
              mountPath: /backups
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: postgres-backup-storage
---
# Postgres Backup Storage PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-backup-storage
  namespace: backup-system
  labels:
    app: postgres-backup
    component: storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
# Postgres Backup Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-backup-config
  namespace: backup-system
  labels:
    app: postgres-backup
    component: config
data:
  host: "postgres.platform-dev.svc.cluster.local"
  port: "5432"
  retention-days: "7"
  minio-endpoint: "http://minio.platform-dev.svc.cluster.local:9000"
  minio-bucket: "postgres-backups"
---
# Postgres Backup Secrets Template (to be sealed)
apiVersion: v1
kind: Secret
metadata:
  name: postgres-backup-secrets-template
  namespace: backup-system
  annotations:
    template: "true"
type: Opaque
stringData:
  username: "postgres"
  password: "changeme123"
  minio-access-key: "minio-access-key"
  minio-secret-key: "minio-secret-key"
