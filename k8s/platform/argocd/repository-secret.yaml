---
# ArgoCD Repository Secret for Private GitHub Repository
# This secret contains credentials for accessing private repositories
apiVersion: v1
kind: Secret
metadata:
  name: argocd-repo-credentials
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd
    app.kubernetes.io/component: repository
    app.kubernetes.io/part-of: comind-ops-platform
type: Opaque
stringData:
  # GitHub Personal Access Token or App credentials
  # Generate at: https://github.com/settings/tokens
  # Required scopes: repo (for private repos), read:org (for organization repos)
  type: git
  url: https://github.com/comind-pro/comind-ops
  username: comind-ops-bot  # GitHub username or bot name
  password: "CHANGE_ME_GITHUB_TOKEN"  # Replace with actual GitHub token
  # Alternative: Use SSH key instead of username/password
  # sshPrivateKey: |
  #   -----BEGIN OPENSSH PRIVATE KEY-----
  #   [SSH_PRIVATE_KEY_CONTENT]
  #   -----END OPENSSH PRIVATE KEY-----

---
# ArgoCD Repository Server SSH Keys Secret
# For SSH-based repository access
apiVersion: v1
kind: Secret
metadata:
  name: argocd-repo-server-ssh-keys
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd
    app.kubernetes.io/component: repository-server
    app.kubernetes.io/part-of: comind-ops-platform
type: Opaque
stringData:
  # SSH private key for GitHub access
  # Generate with: ssh-keygen -t ed25519 -C "argocd@comind-ops"
  # Add public key to GitHub: https://github.com/settings/keys
  ssh_known_hosts: |
    github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl
    github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6Xo5JNt0v84cbhTk5u8He8kSZaGTZKguTq8iXM=
  # SSH private key (replace with actual key)
  id_ed25519: |
    -----BEGIN OPENSSH PRIVATE KEY-----
    [REPLACE_WITH_ACTUAL_SSH_PRIVATE_KEY]
    -----END OPENSSH PRIVATE KEY-----

---
# ArgoCD Project Configuration
# Defines project permissions and repository access
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: comind-ops-platform
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd
    app.kubernetes.io/component: project
    app.kubernetes.io/part-of: comind-ops-platform
spec:
  description: "ComindOps Platform Project"
  
  # Source repositories
  sourceRepos:
    - https://github.com/comind-pro/comind-ops
    - https://github.com/comind-pro/*  # Allow all repos in organization
  
  # Destination clusters
  destinations:
    - namespace: '*'
      server: https://kubernetes.default.svc
    - namespace: 'platform-*'
      server: https://kubernetes.default.svc
    - namespace: '*-dev'
      server: https://kubernetes.default.svc
    - namespace: '*-stage'
      server: https://kubernetes.default.svc
    - namespace: '*-prod'
      server: https://kubernetes.default.svc
  
  # Cluster resource whitelist
  clusterResourceWhitelist:
    - group: ''
      kind: Namespace
    - group: ''
      kind: Node
    - group: ''
      kind: PersistentVolume
    - group: 'apiextensions.k8s.io'
      kind: CustomResourceDefinition
    - group: 'argoproj.io'
      kind: Application
    - group: 'argoproj.io'
      kind: AppProject
  
  # Namespace resource whitelist
  namespaceResourceWhitelist:
    - group: ''
      kind: '*'
    - group: 'apps'
      kind: '*'
    - group: 'extensions'
      kind: '*'
    - group: 'networking.k8s.io'
      kind: '*'
    - group: 'autoscaling'
      kind: '*'
    - group: 'batch'
      kind: '*'
    - group: 'rbac.authorization.k8s.io'
      kind: '*'
    - group: 'policy'
      kind: '*'
    - group: 'monitoring.coreos.com'
      kind: '*'
    - group: 'bitnami.com'
      kind: '*'
    - group: 'metallb.io'
      kind: '*'
    - group: 'sealed-secrets'
      kind: '*'
  
  # Sync windows (optional)
  syncWindows:
    - kind: allow
      schedule: '0 0 * * *'  # Allow syncs at midnight
      duration: 1h
      applications:
        - '*-prod'
      namespaces:
        - '*-prod'
  
  # Roles and permissions
  roles:
    - name: admin
      description: "Admin role with full access"
      policies:
        - p, proj:comind-ops-platform:admin, applications, *, comind-ops-platform/*, allow
        - p, proj:comind-ops-platform:admin, repositories, *, *, allow
        - p, proj:comind-ops-platform:admin, clusters, *, *, allow
      groups:
        - comind-ops:admins
    
    - name: developer
      description: "Developer role with limited access"
      policies:
        - p, proj:comind-ops-platform:developer, applications, get, comind-ops-platform/*, allow
        - p, proj:comind-ops-platform:developer, applications, sync, comind-ops-platform/*-dev, allow
        - p, proj:comind-ops-platform:developer, applications, action/*, comind-ops-platform/*-dev, allow
      groups:
        - comind-ops:developers
