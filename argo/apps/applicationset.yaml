# ArgoCD ApplicationSet for Comind-Ops Platform Applications
# This creates ArgoCD Applications based on apps.yaml configuration
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: comind-ops-platform-apps
  namespace: argocd
  labels:
    app.kubernetes.io/name: comind-ops-applicationset
    app.kubernetes.io/part-of: comind-ops-platform
spec:
  generators:
    - git:
        repoURL: https://github.com/comind-pro/comind-ops
        revision: main
        files:
          - path: "apps.yaml"
  template:
    metadata:
      name: '{{applications.key}}-{{environments.key}}'
      labels:
        app: '{{applications.key}}'
        environment: '{{environments.key}}'
        team: '{{applications.value.team}}'
    spec:
      project: platform-project
      source:
        repoURL: '{{applications.value.repository.url}}'
        targetRevision: '{{environments.value.branch}}'
        path: '{{applications.value.repository.path}}'
        helm:
          valueFiles:
            - 'values/{{environments.key}}.yaml'
          parameters:
            - name: image.tag
              value: '{{environments.value.branch}}'
            - name: ingress.hosts[0].host
              value: '{{environments.value.hostname}}'
            - name: replicaCount
              value: '{{environments.value.replicas}}'
            - name: resources.requests.cpu
              value: '{{environments.value.resources.requests.cpu}}'
            - name: resources.requests.memory
              value: '{{environments.value.resources.requests.memory}}'
            - name: resources.limits.cpu
              value: '{{environments.value.resources.limits.cpu}}'
            - name: resources.limits.memory
              value: '{{environments.value.resources.limits.memory}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{applications.key}}-{{environments.key}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
  syncPolicy:
    preserveResourcesOnDeletion: false

---
# ArgoCD ApplicationSet for Platform Infrastructure
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: comind-ops-platform-infrastructure
  namespace: argocd
  labels:
    app.kubernetes.io/name: comind-ops-infrastructure-applicationset
    app.kubernetes.io/part-of: comind-ops-platform
spec:
  generators:
    - git:
        repoURL: https://github.com/comind-pro/comind-ops
        revision: main
        files:
          - path: "apps.yaml"
  template:
    metadata:
      name: 'infrastructure-{{infrastructure.services.name}}'
      labels:
        app: 'infrastructure'
        component: '{{infrastructure.services.name}}'
        team: platform
    spec:
      project: platform-project
      source:
        repoURL: '{{infrastructure.repository.url}}'
        targetRevision: '{{infrastructure.repository.branch}}'
        path: '{{infrastructure.services.path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{infrastructure.services.name}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true

---
# Root Application to manage ApplicationSets
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: comind-ops-platform-root
  namespace: argocd
  labels:
    app.kubernetes.io/name: comind-ops-root
    app.kubernetes.io/part-of: comind-ops-platform
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform-project
  source:
    repoURL: https://github.com/comind-pro/comind-ops
    targetRevision: main
    path: argo/apps
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
  info:
    - name: Description
      value: "Root application for comind-ops platform GitOps deployment"
