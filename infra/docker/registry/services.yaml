# Service Registry Configuration
# Central registry for all Docker services
# YAML format for easy parsing
#
# INFRASTRUCTURE FLOW:
# 1. Terraform manages: K8s cluster, ArgoCD, initial platform setup
# 2. Docker services provide: External dependencies (local env only)
# 3. ArgoCD manages: Platform services (K8s), application infrastructure

services:
  # REQUIRED SERVICES (Local Environment Only)
  # These services are required for local development
  # In production (AWS), these are replaced by managed services
  
  postgresql:
    enabled: true
    required: true
    description: "Database service - REQUIRED for local development"
    module: postgresql
    config:
      version: "15-alpine"
      port: 5432
      database: "comind_ops_dev"
      username: "postgres"
      password: "postgres"
      data_directory: "./data/postgresql"
      backup_enabled: true
      backup_schedule: "0 2 * * *"
    dependencies: []
    healthcheck:
      command: "pg_isready -U postgres"
      interval: "30s"
      timeout: "10s"
      retries: 3
    integration:
      terraform_validation: true
      argocd_platform_service: "postgresql-dev.platform-dev.svc.cluster.local:5432"

  minio:
    enabled: true
    required: true
    description: "Object storage service - REQUIRED for local development"
    module: minio
    config:
      version: "RELEASE.2023-09-30T07-02-29Z"
      console_port: 9001
      api_port: 9000
      access_key: "minioadmin"
      secret_key: "minioadmin"
      data_directory: "./data/minio"
      buckets: ["uploads", "backups", "logs"]
    dependencies: []
    healthcheck:
      command: "curl -f http://localhost:9000/minio/health/live"
      interval: "30s"
      timeout: "10s"
      retries: 3
    integration:
      terraform_validation: true
      argocd_platform_service: "minio-dev.platform-dev.svc.cluster.local:9000"

  # OPTIONAL SERVICES (Local Environment)
  # These services are optional and can be enabled as needed
  
  redis:
    enabled: false
    required: false
    description: "Caching service - OPTIONAL for local development"
    module: redis
    config:
      version: "7.2-alpine"
      port: 6379
      password: ""
      data_directory: "./data/redis"
      persistence: true
    dependencies: []
    healthcheck:
      command: "redis-cli ping"
      interval: "30s"
      timeout: "10s"
      retries: 3
    integration:
      terraform_validation: false
      argocd_platform_service: "redis-dev-master.platform-dev.svc.cluster.local:6379"

  elasticmq:
    enabled: false
    required: false
    description: "Message queue service - OPTIONAL for local development"
    module: elasticmq
    config:
      version: "1.4.2"
      port: 9324
      data_directory: "./data/elasticmq"
      queues: ["default", "notifications", "processing"]
    dependencies: []
    healthcheck:
      command: "curl -f http://localhost:9324/health"
      interval: "30s"
      timeout: "10s"
      retries: 3
    integration:
      terraform_validation: false
      argocd_platform_service: "elasticmq.platform-dev.svc.cluster.local:9324"

  # External Services (can be added later)
  external_example:
    enabled: false
    module: external
    config:
      image: "nginx:alpine"
      port: 8080
      environment:
        NGINX_HOST: "example.com"
        NGINX_PORT: "80"
      volumes:
        "./config/nginx.conf": "/etc/nginx/nginx.conf"
    dependencies: []
    healthcheck:
      command: "curl -f http://localhost:8080/health"
      interval: "30s"
      timeout: "10s"
      retries: 3

# Service discovery configuration
discovery:
  network_name: "comind-ops-network"
  data_directory: "./data"
  log_directory: "./logs"
  config_directory: "./config"
  
  # Service management
  management:
    auto_start: true
    auto_restart: true
    health_check_interval: "30s"
    backup_enabled: true
    monitoring_enabled: true
  
  # Infrastructure flow integration
  infrastructure_flow:
    # Phase 1: Terraform validation
    terraform_validation: true
    validation_script: "check-external-services.sh"
    
    # Phase 2: Docker services (local only)
    docker_services: true
    required_services: ["postgresql", "minio"]
    optional_services: ["redis", "elasticmq"]
    
    # Phase 3: ArgoCD platform services
    argocd_platform_services: true
    platform_namespace: "platform-dev"
    
    # Service discovery
    discovery_method: "registry"
    config_source: "terraform"
    update_strategy: "rolling"
